# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸš€ GITHUB ACTIONS - DÃ©ploiement Continu (CD)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Deploy to VPS

on:
  push:
    branches:
      - main
    
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:

      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Setup SSH
        run: |
          mkdir -p ~/.ssh
          # ğŸ“ CrÃ©e rÃ©pertoire SSH (non existant par dÃ©faut sur runner)
          
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          # ğŸ”‘ Ã‰crit la clÃ© privÃ©e depuis GitHub Secrets
          # Format attendu : clÃ© ED25519 (plus sÃ©curisÃ©e que RSA)
          # GÃ©nÃ©ration : ssh-keygen -t ed25519 -C "github-actions"
          
          chmod 600 ~/.ssh/id_ed25519
          # ğŸ”’ Permissions strictes (lecture seule pour owner)
          # SSH refuse de fonctionner si permissions trop permissives
          
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          # ğŸ›¡ï¸ Ajoute la clÃ© publique du serveur (Ã©vite prompt "Are you sure?")
          # -H : hash du hostname (sÃ©curitÃ© supplÃ©mentaire)
          # Alternative : ajouter manuellement la fingerprint du serveur

      - name: ğŸ“¦ Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          STUDENT_ID: ${{ secrets.STUDENT_ID }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          ssh $VPS_USER@$VPS_HOST bash << 'ENDSSH'
            set -e
            
            # Variables
            STUDENT_ID="${{ secrets.STUDENT_ID }}"
            REPO_NAME="${{ github.event.repository.name }}"
            PROJECT_DIR="$HOME/apps/${REPO_NAME}-${STUDENT_ID}"
            
            echo "ğŸ“ Dossier: $PROJECT_DIR"
            
            # Clone/Update
            if [ -d "$PROJECT_DIR" ]; then
              cd "$PROJECT_DIR"
              git pull
            else
              cd $HOME/apps
              git clone https://${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git ${REPO_NAME}-${STUDENT_ID}
              cd ${REPO_NAME}-${STUDENT_ID}
            fi
            
            # Copier le .env
            echo "ğŸ“„ Copie du fichier .env..."
            cp $HOME/apps/.env.${STUDENT_ID} .env
            cp $HOME/apps/.env.${STUDENT_ID} docker/.env
            
            # DÃ©ployer
            echo "ğŸ³ DÃ©ploiement Docker..."
            cd docker
            
            # ArrÃªter les containers existants
            docker compose -p cv-${STUDENT_ID} down 2>/dev/null || true
            
            # Build
            echo "ğŸ”¨ Build des images..."
            docker compose -p cv-${STUDENT_ID} build --no-cache
            
            # Up
            echo "ğŸš€ DÃ©marrage des containers..."
            docker compose -p cv-${STUDENT_ID} up -d
            
            # Attendre que les services dÃ©marrent
            echo "â³ Attente du dÃ©marrage..."
            sleep 10
            
            # VÃ©rifier l'Ã©tat
            echo "âœ… Ã‰tat des containers:"
            docker compose -p cv-${STUDENT_ID} ps
            
            # Cleanup
            echo "ğŸ§¹ Nettoyage..."
            docker image prune -af --filter "until=24h"
            
            echo "âœ… DÃ©ploiement terminÃ© pour ${STUDENT_ID}"
          ENDSSH

      - name: âœ… Deployment Success
        run: |
          echo "ğŸ‰ DÃ©ploiement rÃ©ussi pour ${{ secrets.STUDENT_ID }}"
          echo "ğŸ“Š Grafana: http://${{ secrets.VPS_HOST }}:${{ secrets.STUDENT_PORT_GRAFANA }}"
          echo "ğŸ”§ API: http://${{ secrets.VPS_HOST }}:${{ secrets.STUDENT_PORT_API }}"
          echo "ğŸ“ˆ Prometheus: http://${{ secrets.VPS_HOST }}:${{ secrets.STUDENT_PORT_PROMETHEUS }}"
          echo ""
          echo "ğŸ§ª Test de santÃ©:"
          curl -f http://${{ secrets.VPS_HOST }}:${{ secrets.STUDENT_PORT_API }}/health || echo "âš ï¸  API pas encore prÃªte"
